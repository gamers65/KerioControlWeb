<form id="dnsForm">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-gradient bg-primary text-white d-flex justify-content-between align-items-center py-3 px-4">
            <h5 class="mb-0 font-weight-bold">
                <i class="fas fa-globe me-2"></i>DNS Hosts (статические записи)
            </h5>
            <button type="button" class="btn btn-light btn-sm rounded-pill px-3" id="addDns">
                <i class="fas fa-plus me-1"></i>Добавить запись
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="dnsTable">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th width="70" class="text-center">Вкл</th>
                            <th width="160">IP</th>
                            <th width="280">Домен</th>
                            <th>Описание</th>
                            <th width="80" class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Hosts == null || Model.Hosts.Count == 0)
                        {
                            <tr id="noHostsRow">
                                <td colspan="5" class="text-center text-muted py-4 font-italic">Нет DNS хостов</td>
                            </tr>
                        }
                        else
                        {
                            for (int i = 0; i < Model.Hosts.Count; i++)
                            {
                                var host = Model.Hosts[i];
                                <tr>
                                    <td class="text-center align-middle"><input type="checkbox" name="hosts[@i].Enabled" @(host.Enabled ? "checked" : "") class="form-check-input" /></td>
                                    <td><input type="text" class="form-control form-control-sm" name="hosts[@i].Ip" value="@host.Ip" placeholder="Введите IP" /></td>
                                    <td><input type="text" class="form-control form-control-sm" name="hosts[@i].Hosts" value="@host.Hosts" placeholder="Введите домен" /></td>
                                    <td><input type="text" class="form-control form-control-sm" name="hosts[@i].Description" value="@host.Description" placeholder="Введите описание" /></td>
                                    <td class="text-center align-middle">
                                        <center><button type="button" class="btn btn-sm btn-outline-danger rounded-circle deleteDns"><i class="fas fa-trash-alt"></i></button></center>
                                    </td>
                                    <input type="hidden" name="hosts[@i].Id" value="@host.Id" />
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light d-flex justify-content-between align-items-center py-3 px-4">
            <span id="hostsCounter" class="text-muted">
                Записей: <strong>@(Model?.Hosts?.Count ?? 0)</strong>
            </span>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary rounded-pill px-4" id="exportDns">
                    <i class="fas fa-file-export me-2"></i>Сохранить в файл
                </button>
                <button type="button" class="btn btn-warning rounded-pill px-4" id="importDns">
                    <i class="fas fa-file-import me-2"></i>Восстановить из файла
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="saveDns">
                    <i class="fas fa-save me-2"></i>Сохранить изменения
                </button>
            </div>
        </div>
    </div>
</form>

@section Scripts {
<script>
let newIndex = @Model.Hosts?.Count ?? 0;

// Добавление новой строки
function addDnsRow(host = {}) {
    $("#noHostsRow").remove();
    const row = `<tr>
        <td class="text-center align-middle"><input type="checkbox" name="hosts[${newIndex}].Enabled" ${host.Enabled ? "checked" : ""} class="form-check-input" /></td>
        <td><input type="text" class="form-control form-control-sm" name="hosts[${newIndex}].Ip" value="${host.Ip || ''}" placeholder="Введите IP" /></td>
        <td><input type="text" class="form-control form-control-sm" name="hosts[${newIndex}].Hosts" value="${host.Hosts || ''}" placeholder="Введите домен" /></td>
        <td><input type="text" class="form-control form-control-sm" name="hosts[${newIndex}].Description" value="${host.Description || ''}" placeholder="Введите описание" /></td>
        <td class="text-center align-middle"><button type="button" class="btn btn-sm btn-outline-danger rounded-circle deleteDns"><i class="fas fa-trash-alt"></i></button></td>
        <input type="hidden" name="hosts[${newIndex}].Id" value="${host.Id || ''}" />
    </tr>`;
    $("#dnsTable tbody").append(row);
    newIndex++;
    updateCounter();
}

$("#addDns").click(() => addDnsRow());

// Удаление строки
$("#dnsTable").on("click", ".deleteDns", function () {
    $(this).closest("tr").remove();
    if ($("#dnsTable tbody tr").length === 0) {
        $("#dnsTable tbody").append('<tr id="noHostsRow"><td colspan="5" class="text-center text-muted py-4 font-italic">Нет DNS хостов</td></tr>');
    }
    updateCounter();
});

// Счётчик записей
function updateCounter() {
    const count = $("#dnsTable tbody tr").not("#noHostsRow").length;
    $("#hostsCounter strong").text(count);
}

// Сбор данных для отправки
function collectHosts() {
    const formData = $("#dnsForm").serializeArray();
    const hostMap = {};
    formData.forEach(f => {
        const match = f.name.match(/hosts\[(\d+)\]\.(\w+)/);
        if (!match) return;
        const index = match[1];
        const field = match[2];
        if (!hostMap[index]) hostMap[index] = {};
        if (field === "Enabled") hostMap[index][field] = f.value === "on";
        else hostMap[index][field] = f.value;
    });
    const hosts = [];
    for (let key in hostMap) {
        const h = hostMap[key];
        if (!h.Ip?.trim() && !h.Hosts?.trim()) continue;
        hosts.push({
            Id: h.Id || null,
            Ip: h.Ip?.trim() || "",
            Hosts: h.Hosts?.trim() || "",
            Description: h.Description?.trim() || "",
            Enabled: !!h.Enabled
        });
    }
    return hosts;
}

// Сохранение на сервер
$("#saveDns").click(async function () {
    const formData = $("#dnsForm").serializeArray();
    const hosts = [];
    const hostMap = {};

    formData.forEach(f => {
        const match = f.name.match(/hosts\[(\d+)\]\.(\w+)/);
        if (!match) return;
        const index = match[1];
        const field = match[2];
        if (!hostMap[index]) hostMap[index] = {};
        if (field === "Enabled")
            hostMap[index][field] = f.value === "on";
        else
            hostMap[index][field] = f.value;
    });

    for (let key in hostMap) {
        const h = hostMap[key];
        if (!h.Ip && !h.Hosts) continue;
        hosts.push(h);
    }

    if (hosts.length === 0) {
        alert("❌ Нет данных для сохранения");
        return;
    }

    try {
        const response = await fetch('@Url.Action("UpdateDnsHosts", "Home")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(hosts)
        });

        if (response.ok) {
            alert("✅ DNS Hosts успешно сохранены");
            location.reload();
        } else {
            alert("❌ Ошибка при сохранении DNS Hosts");
        }
    } catch (e) {
        alert("❌ Ошибка при сохранении DNS Hosts");
    }
});

// Экспорт в файл
$("#exportDns").click(async function () {
    const hosts = collectHosts();
    if (hosts.length === 0) {
        alert("❌ Нет данных для сохранения в файл");
        return;
    }
    try {
        const resp = await fetch('@Url.Action("SaveDnsToFile", "Home")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(hosts)
        });
        if (resp.ok) alert("✅ DNS Hosts сохранены в файл");
        else alert("❌ Ошибка при сохранении в файл");
    } catch {
        alert("❌ Ошибка при сохранении в файл");
    }
});

// Импорт из файла
$("#importDns").click(async function () {
    try {
        const resp = await fetch('@Url.Action("RestoreDnsFromFile", "Home")');
        const data = await resp.json();
        
        if (!resp.ok) {
            alert("❌ " + (data.message || "Ошибка при загрузке файла"));
            return;
        }

        if (!data.length) {
            alert("❌ Файл пустой");
            return;
        }

        // 1. Загружаем данные в таблицу
        $("#dnsTable tbody").empty();
        newIndex = 0;
        data.forEach(h => addDnsRow(h));

        // 2. НЕМЕДЛЕННО сохраняем данные из файла в Kerio
        try {
            const saveResponse = await fetch('@Url.Action("UpdateDnsHosts", "Home")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (saveResponse.ok) {
                alert("✅ DNS Hosts восстановлены из файла и сохранены в Kerio (" + data.length + " записей)");
                location.reload(); // Перезагружаем для получения актуальных данных
            } else {
                alert("❌ Ошибка при сохранении в Kerio");
            }
        } catch (saveError) {
            alert("❌ Ошибка при сохранении в Kerio: " + saveError.message);
        }
        
    } catch (error) {
        console.error("Import error:", error);
        alert("❌ Ошибка при восстановлении из файла: " + error.message);
    }
});
</script>
}
<style>
    :root {
        --primary: #4361ee;
        --success: #06d6a0;
        --warning: #ff9f1c;
        --danger: #ef476f;
        --dark: #2a2a3b;
        --light: #f8f9fa;
        --gray-100: #f1f3f5;
        --gray-200: #e9ecef;
        --gray-600: #6c757d;
        --gray-800: #343a40;
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        min-height: 100vh;
    }

    /* ==== Карточка (Glass Style) ==== */
    .card {
        border: none !important;
        border-radius: 1rem;
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(12px);
        box-shadow: 0 15px 35px rgba(67, 97, 238, 0.18);
        transition: all 0.35s ease;
    }

    .card:hover {
        box-shadow: 0 25px 55px rgba(67, 97, 238, 0.28);
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary), #3f37c9) !important;
        border: 0;
        border-radius: 1rem 1rem 0 0;
        padding: 1.4rem 1.6rem;
    }

    /* ==== Таблица ==== */
    .table {
        margin: 0 !important;
    }

    .table-hover tbody tr:hover {
        background: rgba(67, 97, 238, 0.08);
        transition: 0.25s;
    }

    thead th {
        background: var(--gray-100) !important;
        border-bottom: 2px solid var(--gray-200) !important;
        font-weight: 600;
        font-size: 0.95rem;
        text-transform: uppercase;
    }

    tbody td input.form-control {
        border-radius: .75rem !important;
        border: 2px solid var(--gray-200) !important;
        padding: .45rem .75rem;
        transition: all .25s ease;
    }

        tbody td input.form-control:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 .25rem rgba(67, 97, 238, 0.25) !important;
        }

    /* ==== Кнопки (унифицированы со страницей Dashboard) ==== */

    .btn {
        border-radius: 0.85rem !important;
        font-weight: 600 !important;
        transition: all 0.25s ease !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        position: relative;
        overflow: hidden;
    }

    /* shine эффект */
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 40%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35));
        transition: 0.6s;
    }

    .btn:hover::before {
        left: 120%;
    }

    .btn-primary {
        background: var(--primary) !important;
        color: white !important;
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-4px) scale(1.03);
        background: #3a56e0 !important;
        box-shadow: 0 10px 25px rgba(67,97,238,0.45) !important;
    }

    .btn-warning {
        background: var(--warning) !important;
        color: white !important;
        border: none;
    }

    .btn-warning:hover {
        background: #ff8b00 !important;
        transform: translateY(-4px) scale(1.03);
        box-shadow: 0 10px 25px rgba(255,159,28,0.45) !important;
    }

    .btn-secondary {
        background: var(--gray-600) !important;
        border: none;
    }

    .btn-secondary:hover {
        transform: translateY(-4px) scale(1.03);
        background: #5a6268 !important;
        box-shadow: 0 10px 25px rgba(108,117,125,0.45) !important;
    }

    .btn-outline-danger {
        border-radius: 50% !important;
        width: 36px;
        height: 36px;
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    .btn-outline-danger:hover {
        background: var(--danger) !important;
        border-color: var(--danger) !important;
        color: white !important;
        transform: scale(1.15);
        box-shadow: 0 0 20px rgba(239, 71, 111, 0.7), 0 8px 20px rgba(0,0,0,0.25);
    }

    /* ==== Футер карточки ==== */
    .card-footer {
        background: var(--gray-100) !important;
        border-radius: 0 0 1rem 1rem;
        padding: 1.2rem 1.6rem !important;
        border-top: 1px solid var(--gray-200) !important;
    }

    #hostsCounter strong {
        color: var(--primary);
        font-size: 1.1rem;
    }

    /* Чекбокс Enabled */
    .form-check-input {
        width: 1.4rem;
        height: 1.4rem;
        cursor: pointer;
    }

    .form-check-input:checked {
        background-color: var(--success);
        border-color: var(--success);
        box-shadow: 0 0 8px rgba(6,214,160,0.4);
    }

    #dnsForm .card {
        max-width: 1200px;
        margin: 0 auto;
    }
</style>
